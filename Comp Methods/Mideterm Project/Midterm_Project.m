clc
clear

iter = 1;
maxiter = 101;

for K = 1:40;
    while iter<maxiter;
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PCA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

load ('Ytrain.mat')
load('Ytest.mat')

Y = (Ytrain)';
[m,n] = size(Ytest);

%%% Perform the PCA analysis %%%
[m, n] = size(Y); 

% 1. Compute sample covariance
C = cov(Y);

% 2. SVD on C
[U, S, V] = svd(C);

% 3. select the first 2 columns of U
U1 = U(:,1:K);
Z = U1'*Ytrain;

% % show all data
% for i = 1:m
figure(2)
    I = reshape(Ytest(:,14),28,23);
    imagesc(I);
    colormap(gray)
    axis equal;
    %pause(0.5);
% end 

figure(3)
I = reshape(Ytrain(:,12),28,23);
imagesc(I);
colormap(gray);
axis equal;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Simple Projection %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

W = eye(644);
U2 = W(:,1:K);
Y1 = (U2)'*Ytrain;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% Form Feature Vector %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

I = Ytest(:,ceil(K*rand(1)));
I1 = U2'*I;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%% Compute Metric %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for i = 1:200
    Dist(i) = norm(I1-Y1(:,i));
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% Find Nearest Neighbor %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

[a b] = size(Y1);

for i = 1:b
    d1(i) = norm(I1-Y1(:,i),2);
    [dis1, dis_ind1] = sort(d1(i));
    nn1(i) = dis_ind1(1);
end
for i = 1:b
   d2(i) = norm(I1-Z(:,i),2);
   [dis2, dis_ind2] = sort(d2(i));
   nn2(i) = dis_ind2(1);
end
    end
    iter = iter+1;
end